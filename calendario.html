<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Study Planner v5.1</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#1f2937; --border:#334155; --text:#e5e7eb; --sub:#94a3b8; --accent:#6366f1; }
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Noto Sans,sans-serif;
      font-size:18px;
      display:flex;
      flex-direction:column;
    }
    h1{text-align:center;font-size:2rem;margin:22px 0;}
    h2{font-size:1.2rem;margin:16px;color:var(--sub);}    
    .wrap{max-width:1100px;margin:0 auto;padding:10px 14px 28px;flex:1 0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .toolbar{display:flex;gap:14px;align-items:flex-end;flex-wrap:wrap}
    label{font-size:1rem;color:var(--sub);display:flex;flex-direction:column;gap:6px}
    input[type="text"],input[type="number"],input[type="date"],input[type="file"]{
      background:var(--muted);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      min-width:140px;
      outline:none;
      font-size:1rem;
    }
    button{
      appearance:none;
      border:none;
      background:var(--accent);
      color:white;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      font-size:0.95rem;
      white-space:nowrap;
    }
    button:hover{filter:brightness(1.1)}
    .columns{display:flex;gap:22px;margin-top:16px;flex-wrap:wrap}
    .column{flex:1 1 360px;border:1px solid var(--border);border-radius:16px;background:var(--muted);padding:14px}
    .column h3{text-align:center;margin-top:0;font-size:1.2rem}
    .summary{margin-top:18px}
    .late{color:#f97373;font-weight:700;}
    @media (max-width: 640px){ body{font-size:17px} h1{font-size:1.6rem} .wrap{padding:8px} input,button{font-size:1rem} }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded",()=>{
      // DOM refs
      const dateField=document.getElementById("currentDate");
      const setTodayBtn=document.getElementById("setTodayBtn");
      const importInput=document.getElementById("importInput");
      const exportButton=document.getElementById("exportButton");
      const statOutput=document.getElementById("statOutput");
      const autoOutput=document.getElementById("autoOutput");
      const summaryOutput=document.getElementById("summaryOutput");
      const subject1NameField=document.getElementById("subject1Name");
      const subject2NameField=document.getElementById("subject2Name");
      const subject1LessonsField=document.getElementById("subject1Lessons");
      const subject2LessonsField=document.getElementById("subject2Lessons");
      const endDateField=document.getElementById("endDate");
      const lessonsPerDayField=document.getElementById("lessonsPerDay");
      const lastLesson1Field=document.getElementById("lastLesson1");
      const lastLesson2Field=document.getElementById("lastLesson2");
      const subject1Title=document.getElementById("subject1Title");
      const subject2Title=document.getElementById("subject2Title");
      const ll1Text=document.getElementById("ll1Text");
      const ll2Text=document.getElementById("ll2Text");
      const done1Button=document.getElementById("done1Button");
      const done2Button=document.getElementById("done2Button");
      const reset1Button=document.getElementById("reset1Button");
      const reset2Button=document.getElementById("reset2Button");

      function formatDate(d){
        const mesi=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
        return d.getDate()+" "+mesi[d.getMonth()];
      }

      function getConfig(){
        return {
          currentDate: dateField.value,
          subject1Name: subject1NameField.value,
          subject1Lessons: subject1LessonsField.value,
          subject2Name: subject2NameField.value,
          subject2Lessons: subject2LessonsField.value,
          lessonsPerDay: lessonsPerDayField.value,
          endDate: endDateField.value,
          lastLesson1: lastLesson1Field.value,
          lastLesson2: lastLesson2Field.value
        };
      }
      function setConfig(data){
        if(data.currentDate!==undefined) dateField.value=data.currentDate;
        if(data.subject1Name!==undefined) subject1NameField.value=data.subject1Name;
        if(data.subject1Lessons!==undefined) subject1LessonsField.value=data.subject1Lessons;
        if(data.subject2Name!==undefined) subject2NameField.value=data.subject2Name;
        if(data.subject2Lessons!==undefined) subject2LessonsField.value=data.subject2Lessons;
        if(data.lessonsPerDay!==undefined) lessonsPerDayField.value=data.lessonsPerDay;
        if(data.endDate!==undefined) endDateField.value=data.endDate;
        if(data.lastLesson1!==undefined) lastLesson1Field.value=data.lastLesson1;
        if(data.lastLesson2!==undefined) lastLesson2Field.value=data.lastLesson2;
      }
      function exportConfig(){
        const cfg=getConfig();
        const blob=new Blob([JSON.stringify(cfg,null,2)],{type:"application/json"});
        const url=URL.createObjectURL(blob); const a=document.createElement("a");
        a.href=url; a.download="studio-config.json"; a.click(); URL.revokeObjectURL(url);
      }
      function importConfig(evt){
        const file=evt.target.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=e=>{ try{ const data=JSON.parse(e.target.result); setConfig(data); updateSchedule(); }catch(err){ alert("File JSON non valido"); } };
        reader.readAsText(file);
      }

      function updateSchedule(){
        const subj1=subject1NameField.value||"Materia 1";
        const subj2=subject2NameField.value||"Materia 2";
        let total1=Math.max(0,parseInt(subject1LessonsField.value)||72);
        let total2=Math.max(0,parseInt(subject2LessonsField.value)||72);
        const endDate=new Date(endDateField.value);
        const today=new Date(dateField.value);
        const perDay=Math.max(1,parseInt(lessonsPerDayField.value)||3);
        let last1=Math.max(0,parseInt(lastLesson1Field.value)||0);
        let last2=Math.max(0,parseInt(lastLesson2Field.value)||0);

        // clamp ultimo completato al massimo numero di lezioni
        if(last1>total1){ last1=total1; lastLesson1Field.value=total1; }
        if(last2>total2){ last2=total2; lastLesson2Field.value=total2; }

        const msPerDay=1000*60*60*24;

        // Update labels with subject names
        subject1Title.textContent=subj1; subject2Title.textContent=subj2;
        ll1Text.textContent=`Ultima lezione completata ${subj1}`;
        ll2Text.textContent=`Ultima lezione completata ${subj2}`;

        const schedule1=[], schedule2=[];
        let l1=last1+1, l2=last2+1;
        let dayIndex=0;
        let lastStudyTime=null;

        while(l1<=total1 || l2<=total2){
          const day=new Date(today.getTime()+dayIndex*msPerDay);
          const isLate = day > endDate; // il giorno di termine Ã¨ ancora "in tempo"
          const cls = isLate ? 'late' : '';

          if(l1<=total1){
            const end=Math.min(l1+perDay-1,total1);
            const nums=[]; for(let n=l1;n<=end;n++) nums.push(n);
            schedule1.push(`<span class="${cls}">${formatDate(day)}: Lezione ${nums[0]}${nums.length>1?', '+nums.slice(1).join(', '):''}</span>`);
            l1=end+1;
          } else if(l2<=total2){
            const end=Math.min(l2+perDay-1,total2);
            const nums=[]; for(let n=l2;n<=end;n++) nums.push(n);
            schedule2.push(`<span class="${cls}">${formatDate(day)}: Lezione ${nums[0]}${nums.length>1?', '+nums.slice(1).join(', '):''}</span>`);
            l2=end+1;
          }
          lastStudyTime = day.getTime();
          dayIndex++;
        }
        statOutput.innerHTML=schedule1.join("<br>");
        autoOutput.innerHTML=schedule2.join("<br>");

        const rem1=Math.max(0,total1-last1), rem2=Math.max(0,total2-last2);

        let delayText;
        if(lastStudyTime===null){
          delayText = "Nessuna lezione rimanente";
        } else {
          const lastStudyDate = new Date(lastStudyTime);
          // normalizza a mezzanotte per sicurezza
          const endMid = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
          const lastMid = new Date(lastStudyDate.getFullYear(), lastStudyDate.getMonth(), lastStudyDate.getDate());
          const diffDays = Math.round((lastMid - endMid)/msPerDay);

          if(diffDays > 0){
            delayText = `Ritardo di ${diffDays} giorni`;
          } else if(diffDays < 0){
            delayText = `Anticipo di ${-diffDays} giorni`;
          } else {
            delayText = "In tempo sulla scadenza";
          }
        }

        summaryOutput.innerHTML = `${subj1}: ${rem1} lezioni rimanenti<br>${subj2}: ${rem2} lezioni rimanenti<br><strong>${delayText}</strong>`;
      }

      // Auto-recalc on parameter change
      const watched=[dateField,subject1NameField,subject2NameField,subject1LessonsField,subject2LessonsField,endDateField,lessonsPerDayField,lastLesson1Field,lastLesson2Field];
      watched.forEach(el=>{ ["change","input"].forEach(ev=> el.addEventListener(ev, updateSchedule)); });

      // Buttons
      if(exportButton) exportButton.addEventListener("click",exportConfig);
      if(importInput) importInput.addEventListener("change",importConfig);

      if(done1Button) done1Button.addEventListener("click",()=>{
        const total1=Math.max(0,parseInt(subject1LessonsField.value)||0);
        lastLesson1Field.value=total1;
        updateSchedule();
      });
      if(done2Button) done2Button.addEventListener("click",()=>{
        const total2=Math.max(0,parseInt(subject2LessonsField.value)||0);
        lastLesson2Field.value=total2;
        updateSchedule();
      });
      if(reset1Button) reset1Button.addEventListener("click",()=>{
        lastLesson1Field.value=0;
        updateSchedule();
      });
      if(reset2Button) reset2Button.addEventListener("click",()=>{
        lastLesson2Field.value=0;
        updateSchedule();
      });
      if(setTodayBtn) setTodayBtn.addEventListener("click",()=>{
        dateField.value=new Date().toISOString().split("T")[0];
        updateSchedule();
      });

      // Init
      if(!dateField.value){
        dateField.value=new Date().toISOString().split("T")[0];
      }
      updateSchedule();
    });
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Study Planner v5.1</h1>

    <h2>Impostazioni</h2>
    <div class="card toolbar">
      <label>Nome Materia 1<input type="text" id="subject1Name" placeholder="Statistica"></label>
      <label>Numero Lezioni<input type="number" id="subject1Lessons" min="1" value="72"></label>
      <label>Nome Materia 2<input type="text" id="subject2Name" placeholder="Automatica"></label>
      <label>Numero Lezioni<input type="number" id="subject2Lessons" min="1" value="72"></label>
      <label>Lezioni per giorno<input type="number" id="lessonsPerDay" min="1" value="3"></label>
      <label>Data fine<input type="date" id="endDate" value="2025-02-12"></label>
      <label>Carica configurazione<input type="file" id="importInput" accept="application/json"></label>
      <button id="exportButton">Salva configurazione</button>
    </div>

    <h2>Progressi</h2>
    <div class="card toolbar">
      <label>Data odierna
        <input type="date" id="currentDate">
        <button type="button" id="setTodayBtn">Oggi</button>
      </label>
      <label><span id="ll1Text">Ultima lezione completata Materia 1</span>
        <input type="number" id="lastLesson1" min="0" value="0">
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
          <button type="button" id="reset1Button">RESET STUDIO</button>
          <button type="button" id="done1Button">STUDIO TERMINATO</button>
        </div>
      </label>
      <label><span id="ll2Text">Ultima lezione completata Materia 2</span>
        <input type="number" id="lastLesson2" min="0" value="0">
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
          <button type="button" id="reset2Button">RESET STUDIO</button>
          <button type="button" id="done2Button">STUDIO TERMINATO</button>
        </div>
      </label>
    </div>

    <div class="columns">
      <div class="column">
        <h3 id="subject1Title">Materia 1</h3>
        <div id="statOutput"></div>
      </div>
      <div class="column">
        <h3 id="subject2Title">Materia 2</h3>
        <div id="autoOutput"></div>
      </div>
    </div>

    <div class="card summary">
      <h2>Riepilogo</h2>
      <div id="summaryOutput"></div>
    </div>
  </div>
</body>
</html>
